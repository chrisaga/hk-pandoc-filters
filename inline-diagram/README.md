---
title: "Inline Diagram - Pandoc lua filter to process embedded vector diagrams"
author: "Christophe Agathon"
---

Inline Diagram
=======

Process embeded vector diagrams from various format with optimized image file handling. We try to minimize image generation and conversion for the best results possible.

v1.0. Copyright: © 2022 Christophe Agathon
  <christophe.agathon@gmail.com>
License:  MIT - see LICENSE file for details.

Introduction
------------

TODO : As an author I want to produce document format from the
same sources using the more appropriate image file available in
order to get the "best" result (image quality, document weight,
...).


THE REAL GOOD SOLUTION SEEEMS TO SPLIT WORK BETWEEN A FILTER FOR DEFAULT BEHAVIOUR AND A WRITER FOR ADVANCED BEHAVIOUR IN LATEX
See the html sample.lua writer deal with GraphViz dot diagram

Usage
-----

### Formating the document

Use Pandoc's markdown code blocks to embed the diagram code in your markdown source. Code can be : PlantUML, GraphViz, LaTeX/Ti*k*Z, Python, Asymptote.

~~~ {.markdown}

```{.classname .image caption="Figure caption"}

[ Some code there ]

```
~~~

With classname in :

* plantuml
* graphviz
* tikz (or tikz2image for backward compatibility with diagram-generator)
* python (or py2image for backward compatibility with diagram-generator)
* asymptote

`.image` is optional for now for compatibility with `diagram-generator.lua`. In the future it will allow to render both source code with syntax highlighting and diagrams in the same document.


### Rendering the document

Copy `latex_hk_writer.lua` in your document folder or in your
pandoc data directory (details in
[Pandoc's manual](https://pandoc.org/MANUAL.html#custom-readers-and-writers)).
Run it on your document with a `--luafilter` option:

```bash
pandoc --write=latex_hk_writer.lua --template=default.latex --pdf-engine=pdflatex -o OUTPUT.pdf SOURCE.md

```


## Limitations

This filter is aimed to LaTeX, PDF, HTML and ASCII(PlantUML only) output. It does his best (png images) with other output document format.


### Credits

This filter is widely based on `diagram-generator.lua` by John MacFarlane, Florian Schätzig, Thorsten Sommer, Albert Krewinkel and contributors.

### History

#### Image formats regarding to output document format

I initially looked at `diagram-generator.lua`'s code to deal with issues I had with pdf to svg conversion. I read the posts about recurring problems with this conversion and why it's done with Inkscape now.

I understand it's complicated to build a stable solution for both Windows and Linux (and others), but *why on earth should I struggle with an image conversion when rendering PDF files ?*

* PDF files are rendered via LaTeX which is used to render the Ti*k*Z images. Why not properly embed the Ti*k*Z code in the LaTeX document ?
* PlantUML and GraphViz can output PDF images suitable for processing with `pdflatex`. Better then, They can output Ti*k*Z code whitch put us back to the previous case.
* Python can output PDF images with the proper call to `plt.savefig`
* A quick search on [Asymptote documentation](https://asymptote.sourceforge.io/doc/LaTeX-usage.html) shows that it seems to live pretty well with LaTeX and allows ebedding code in LaTeX too.

#### Markdown syntax

CodeBlocks are used to carry the diagram code which might be surprising. This class of block is usually used to display code (sometime with "beautification").  Maybe this was the only option when the filter was created. After all diagram rendering might be considered as the ultimate code beautification ;-) and you always can use a different class name if you want to display the code.


### Internal image generation and conversion

| Diagram format | LaTex / PDF | HTML | txt | Note |
|------|---------|---|---|-------------------|
| PlantUML  | LaTeX/Ti*k*Z (generated by plantuml) | ext svg | ASCII art | generate LaTeX/Ti*k*Z, ASCII or external image using `plantuml` |
| Ti*k*Z    | LaTeX/Ti*k*Z (Lua filter, no external command)| ext svg | | Ti*k*Z is compiled in LaTeX need a conversion for non native LaTeX |
| Graphviz  | ext pdf (generated by dot) | ext svg | | generate ext images using `dot` |
| Python    | ext pdf | ext svg |  | See mathplotlib ('png', 'pdf', 'svg', eps, others ?) NB. The `plt.savefig` call could be optional and generated by the filter |
| Asymptote | TBD | TBD | TBD | See asy |



Contributing
------------

PRs welcome.

